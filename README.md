# offlinenotice

Configuration scripts used to allow Node Red to check the status of each node. If node is offline, an email will be sent.

1. Run 

<code>bash <(curl -sL https://raw.githubusercontent.com/Skyboxpro/offlinenotice/master/initialise.sh)</code>

2. Open Node Red

Import the following flow snippet:

<code>[{"id":"f120a239.1261e","type":"tab","label":"Online Status","disabled":false,"info":""},{"id":"39699c56.963ac4","type":"e-mail","z":"f120a239.1261e","server":"smtp.gmail.com","port":"465","secure":true,"name":"","dname":"To Email","x":820,"y":620,"wires":[]},{"id":"390ce5c6.5ed6ca","type":"function","z":"f120a239.1261e","name":"Email Notification","func":"msg = {\n    payload : \"Your Skyminer is currently offline! Make sure to reboot asap.\" + Date().toString(),\n    topic : \"Emergency! You're Skyminer is Offline!\",\n};\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":580,"wires":[["39699c56.963ac4"]]},{"id":"e9feadd3.4daa4","type":"delay","z":"f120a239.1261e","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"hour","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":830,"y":540,"wires":[["390ce5c6.5ed6ca"]]},{"id":"4da4453b.5f268c","type":"inject","z":"f120a239.1261e","name":"Run Flow Every 2 Seconds","topic":"","payload":"","payloadType":"date","repeat":"2","crontab":"","once":false,"onceDelay":0.1,"x":360,"y":140,"wires":[["396672b1.f7711e"]]},{"id":"e1bd768b.eddb38","type":"exec","z":"f120a239.1261e","command":"./allstatus.sh","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"Run Node Status Script","x":510,"y":260,"wires":[["e2ca4aa1.d338e8"],[],[]]},{"id":"28228309.4faa8c","type":"comment","z":"f120a239.1261e","name":"Send Notification Email","info":"","x":860,"y":500,"wires":[]},{"id":"fdfafa68.ccdb58","type":"comment","z":"f120a239.1261e","name":"Node Status Dashboard","info":"","x":860,"y":120,"wires":[]},{"id":"243edb0.35b8426","type":"ui_text","z":"f120a239.1261e","group":"78f2a671.ca2ab8","order":0,"width":0,"height":0,"name":"Node 1","label":"Node 1","format":"<font color=\"{{((msg.rpi01)  == 'online') ? 'green' : 'red'}}\">{{msg.rpi01}} </font>","layout":"row-spread","x":820,"y":160,"wires":[]},{"id":"cabac66a.3ca218","type":"ui_text","z":"f120a239.1261e","group":"78f2a671.ca2ab8","order":0,"width":0,"height":0,"name":"Node 2","label":"Node 2","format":"<font color=\"{{((msg.rpi02)  == 'online') ? 'green' : 'red'}}\">{{msg.rpi02}} </font>","layout":"row-spread","x":820,"y":200,"wires":[]},{"id":"3a6ee5e5.f4e5ea","type":"ui_text","z":"f120a239.1261e","group":"78f2a671.ca2ab8","order":0,"width":0,"height":0,"name":"Node 3","label":"Node 3","format":"<font color=\"{{((msg.rpi03)  == 'online') ? 'green' : 'red'}}\">{{msg.rpi03}} </font>","layout":"row-spread","x":820,"y":240,"wires":[]},{"id":"276539b0.3b5f46","type":"ui_text","z":"f120a239.1261e","group":"78f2a671.ca2ab8","order":0,"width":0,"height":0,"name":"Node 4","label":"Node 4","format":"<font color=\"{{((msg.rpi04)  == 'online') ? 'green' : 'red'}}\">{{msg.rpi04}} </font>","layout":"row-spread","x":820,"y":280,"wires":[]},{"id":"3e018c46.d6bb74","type":"ui_text","z":"f120a239.1261e","group":"78f2a671.ca2ab8","order":0,"width":0,"height":0,"name":"Node 5","label":"Node 5","format":"<font color=\"{{((msg.rpi05)  == 'online') ? 'green' : 'red'}}\">{{msg.rpi05}} </font>","layout":"row-spread","x":820,"y":320,"wires":[]},{"id":"804c6132.d1646","type":"ui_text","z":"f120a239.1261e","group":"78f2a671.ca2ab8","order":0,"width":0,"height":0,"name":"Node 6","label":"Node 6","format":"<font color=\"{{((msg.rpi06)  == 'online') ? 'green' : 'red'}}\">{{msg.rpi06}} </font>","layout":"row-spread","x":820,"y":360,"wires":[]},{"id":"b683a411.e5a918","type":"ui_text","z":"f120a239.1261e","group":"78f2a671.ca2ab8","order":0,"width":0,"height":0,"name":"Node 7","label":"Node 7","format":"<font color=\"{{((msg.rpi07)  == 'online') ? 'green' : 'red'}}\">{{msg.rpi07}} </font>","layout":"row-spread","x":820,"y":400,"wires":[]},{"id":"8334631e.17c76","type":"ui_text","z":"f120a239.1261e","group":"78f2a671.ca2ab8","order":0,"width":0,"height":0,"name":"Node 8","label":"Node 8","format":"<font color=\"{{((msg.rpi08)  == 'online') ? 'green' : 'red'}}\">{{msg.rpi08}} </font>","layout":"row-spread","x":820,"y":440,"wires":[]},{"id":"e2ca4aa1.d338e8","type":"function","z":"f120a239.1261e","name":"Update Node Status","func":"var node = msg.payload\n\nif(node.includes(\"rpi01 is online\")){\n    msg.rpi01 = \"online\"\n}\nif(node.includes(\"rpi02 is online\")){\n    msg.rpi02 = \"online\"\n}\nif(node.includes(\"rpi03 is online\")){\n    msg.rpi03 = \"online\"\n}\nif(node.includes(\"rpi04 is online\")){\n    msg.rpi04 = \"online\"\n}\nif(node.includes(\"rpi05 is online\")){\n    msg.rpi05 = \"online\"\n}\nif(node.includes(\"rpi06 is online\")){\n    msg.rpi06 = \"online\"\n}\nif(node.includes(\"rpi07 is online\")){\n    msg.rpi07 = \"online\"\n}\nif(node.includes(\"rpi08 is online\")){\n    msg.rpi08 = \"online\"\n}\n\nif(!node.includes(\"rpi01\")){\n    msg.rpi01 = \"not connected\"\n}\nif(!node.includes(\"rpi02\")){\n    msg.rpi02 = \"not connected\"\n}\nif(!node.includes(\"rpi03\")){\n    msg.rpi03 = \"not connected\"\n}\nif(!node.includes(\"rpi04\")){\n    msg.rpi04 = \"not connected\"\n}\nif(!node.includes(\"rpi05\")){\n    msg.rpi05 = \"not connected\"\n}\nif(!node.includes(\"rpi06\")){\n    msg.rpi06 = \"not connected\"\n}\nif(!node.includes(\"rpi07\")){\n    msg.rpi07 = \"not connected\"\n}\nif(!node.includes(\"rpi08\")){\n    msg.rpi08 = \"not connected\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":320,"wires":[["e9feadd3.4daa4","243edb0.35b8426","cabac66a.3ca218","3a6ee5e5.f4e5ea","276539b0.3b5f46","3e018c46.d6bb74","804c6132.d1646","b683a411.e5a918","8334631e.17c76"]]},{"id":"396672b1.f7711e","type":"function","z":"f120a239.1261e","name":"Assume Nodes are offline","func":"\n\nmsg.rpi01 = \"offline\"\nmsg.rpi02 = \"offline\"\nmsg.rpi03 = \"offline\"\nmsg.rpi04 = \"offline\"\nmsg.rpi05 = \"offline\"\nmsg.rpi06 = \"offline\"\nmsg.rpi07 = \"offline\"\nmsg.rpi08 = \"offline\"\n\n\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":200,"wires":[["e1bd768b.eddb38"]]},{"id":"78f2a671.ca2ab8","type":"ui_group","z":"","name":"Node Status","tab":"8b19c4bf.1e7318","disp":true,"width":"6","collapse":false},{"id":"8b19c4bf.1e7318","type":"ui_tab","z":"","name":"Node Status","icon":"dashboard","disabled":false,"hidden":false}]</code>

3. Update email settings in 'To Email' Node.
4. Click Deploy and navigate to https://MANAGER-IP-ADDRESS/1880/ui
5. If node is offline - you will recieve an email once per hour.
