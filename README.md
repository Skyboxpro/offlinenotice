# offlinenotice

Configuration scripts used to allow Node Red to check the status of each node. If node is offline, an email will be sent.

1. Run 

<code>bash <(curl -sL https://raw.githubusercontent.com/Skyboxpro/offlinenotice/master/initialise.sh)</code>

2. Open Node Red

Import the following flow snippet:

<code>[{"id":"8a0399f4.75dac8","type":"tab","label":"Online Status","disabled":false,"info":""},{"id":"1e2f09a0.eebbb6","type":"change","z":"8a0399f4.75dac8","name":"Node OFF","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":730,"y":300,"wires":[["a898e0e0.f80fe","8d7e688a.56eaa8","987cdd03.27d6","a8305f13.0778c"]]},{"id":"e38d9cdb.14d65","type":"change","z":"8a0399f4.75dac8","name":"Node ON","rules":[{"t":"set","p":"payload","pt":"msg","to":"0","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":720,"y":520,"wires":[["8d7e688a.56eaa8","987cdd03.27d6","6dab3f43.38da1"]]},{"id":"129632db.a5061d","type":"e-mail","z":"8a0399f4.75dac8","server":"smtp.gmail.com","port":"465","secure":true,"name":"adam@skyboxpro.net","dname":"To Email","x":980,"y":320,"wires":[]},{"id":"3575b2ba.5b14be","type":"function","z":"8a0399f4.75dac8","name":"Email Notification","func":"msg = {\n    payload : \"Your Skybox is currently offline! Make sure to reboot asap.\" + Date().toString(),\n    topic : \"Emergency!\",\n};\nreturn msg;","outputs":1,"noerr":0,"x":970,"y":280,"wires":[["129632db.a5061d"]]},{"id":"a898e0e0.f80fe","type":"delay","z":"8a0399f4.75dac8","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"hour","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":910,"y":240,"wires":[["3575b2ba.5b14be"]]},{"id":"a9b2c6ff.f2ea58","type":"inject","z":"8a0399f4.75dac8","name":"","topic":"","payload":"","payloadType":"date","repeat":"2","crontab":"","once":false,"onceDelay":0.1,"x":150,"y":160,"wires":[["55607c65.a9e3f4"]]},{"id":"cd3109a7.84bdb8","type":"exec","z":"8a0399f4.75dac8","command":"./status.sh","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"Check online","x":170,"y":360,"wires":[["39627907.702a06"],[],[]]},{"id":"39627907.702a06","type":"switch","z":"8a0399f4.75dac8","name":"Nodes on/off","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"offline","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":190,"y":460,"wires":[["6cd92144.7fa8f"],["e38d9cdb.14d65"]]},{"id":"f7c1660b.0de5c8","type":"change","z":"8a0399f4.75dac8","name":"Node 1 Off","rules":[{"t":"set","p":"rpi01","pt":"msg","to":"offline","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":300,"wires":[["1e2f09a0.eebbb6"]]},{"id":"e2a335df.1ea048","type":"change","z":"8a0399f4.75dac8","name":"Node 2 Off","rules":[{"t":"set","p":"rpi02","pt":"msg","to":"offline","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":340,"wires":[["1e2f09a0.eebbb6"]]},{"id":"6cd92144.7fa8f","type":"switch","z":"8a0399f4.75dac8","name":"Split nodes","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"rpi01 is offline","vt":"str"},{"t":"cont","v":"rpi02 is offline","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":370,"y":420,"wires":[["f7c1660b.0de5c8"],["e2a335df.1ea048"]]},{"id":"8d7e688a.56eaa8","type":"ui_text","z":"8a0399f4.75dac8","group":"78f2a671.ca2ab8","order":0,"width":0,"height":0,"name":"Rpi01","label":"Node 1","format":"{{msg.rpi01}}","layout":"row-left","x":1110,"y":420,"wires":[]},{"id":"987cdd03.27d6","type":"ui_text","z":"8a0399f4.75dac8","group":"78f2a671.ca2ab8","order":0,"width":0,"height":0,"name":"Rpi02","label":"Node 2","format":"{{msg.rpi02}}","layout":"row-left","x":1110,"y":460,"wires":[]},{"id":"a8305f13.0778c","type":"link out","z":"8a0399f4.75dac8","name":"Node off","links":["90c87b73.8be5c8"],"x":855,"y":420,"wires":[]},{"id":"6dab3f43.38da1","type":"link out","z":"8a0399f4.75dac8","name":"Node On","links":["fa506e60.6e61e"],"x":855,"y":620,"wires":[]},{"id":"55607c65.a9e3f4","type":"change","z":"8a0399f4.75dac8","name":"Node 1 On","rules":[{"t":"set","p":"rpi01","pt":"msg","to":"online","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":190,"y":240,"wires":[["464fae7e.98cd7"]]},{"id":"464fae7e.98cd7","type":"change","z":"8a0399f4.75dac8","name":"Node 2 On","rules":[{"t":"set","p":"rpi02","pt":"msg","to":"online","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":190,"y":280,"wires":[["cd3109a7.84bdb8"]]},{"id":"78f2a671.ca2ab8","type":"ui_group","z":"","name":"Node Status","tab":"8b19c4bf.1e7318","disp":true,"width":"6","collapse":false},{"id":"8b19c4bf.1e7318","type":"ui_tab","z":"","name":"Node Status","icon":"dashboard","disabled":false,"hidden":false}]</code>

3. Update email settings in 'To Email' Node.
